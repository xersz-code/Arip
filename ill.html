<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RNG Game Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
body { background:#111; color:#eee; font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px;}
.box { width:500px; text-align:center; border:1px solid #333; padding:20px; margin-bottom:20px; }
input { padding:8px; margin:5px; width:80%; }
button { padding:8px 16px; margin:5px; cursor:pointer; background:#222; color:#fff; border:1px solid #555; }
button:hover { background:#333; }
.roll { font-size:32px; margin:10px 0; }
.plus { color:#55ff55; }
.minus { color:#ff5555; }
.leaderboard { display:flex; flex-wrap: wrap; justify-content:flex-start; gap:10px; width:100%; }
.leaderboard div { border:1px solid #555; padding:5px; flex:1 0 30%; text-align:center; }
</style>
</head>
<body>

<div class="box" id="authBox">
  <h2>Signup / Login</h2>
  <input type="text" id="usernameInput" placeholder="Username"><br>
  <input type="password" id="passwordInput" placeholder="Password"><br>
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Log In</button>
  <p id="authMsg"></p>
</div>

<div class="box" id="gameBox" style="display:none;">
  <p>Welcome, <span id="userDisplay"></span>!</p>
  <p>Score: <span id="score">0</span></p>
  <div class="roll" id="roll">---</div>
  <button onclick="startRoll()">ROLL</button>
</div>

<div class="box">
  <h3>Leaderboard</h3>
  <div class="leaderboard" id="leaderboard">Loading...</div>
</div>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCqVnGUCuuqKXxEhBVqF-7SDdqbZ7or4W0",
  authDomain: "rngg-bb71a.firebaseapp.com",
  projectId: "rngg-bb71a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let score = 0;
let rolling = false;

// --- Show auth message ---
function showAuthMsg(msg){
  document.getElementById('authMsg').textContent = msg;
}

// --- Signup ---
async function signup(){
  const username = document.getElementById('usernameInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  if(!username || !password){ showAuthMsg("Enter username & password"); return; }

  // Check for invalid Firestore doc characters
  if(/[\/.#$[\]]/.test(username)){ showAuthMsg("Invalid username"); return; }

  try{
    const userRef = db.collection("users").doc(username);
    const doc = await userRef.get();
    if(doc.exists){ showAuthMsg("Username already exists"); return; }

    await userRef.set({ password, score: 0 });
    showAuthMsg("Signup successful! You can now log in.");
  }catch(e){
    showAuthMsg("Error: " + e.message);
  }
}

// --- Login ---
async function login(){
  const username = document.getElementById('usernameInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  if(!username || !password){ showAuthMsg("Enter username & password"); return; }

  try{
    const userRef = db.collection("users").doc(username);
    const doc = await userRef.get();
    if(!doc.exists || doc.data().password !== password){
      showAuthMsg("Invalid username or password"); return;
    }

    currentUser = username;
    score = doc.data().score || 0;
    document.getElementById('userDisplay').textContent = currentUser;
    document.getElementById('score').textContent = score;
    document.getElementById('authBox').style.display = "none";
    document.getElementById('gameBox').style.display = "block";
    updateLeaderboard();
  }catch(e){
    showAuthMsg("Error: " + e.message);
  }
}

// --- RNG Roll ---
function startRoll(){
  if(rolling) return;
  rolling = true;
  const rollEl = document.getElementById("roll");
  let ticks = 0;
  const totalTicks = 20 + Math.floor(Math.random()*10);

  const interval = setInterval(()=>{
    const tempNum = Math.floor(Math.random()*200)+1;
    const tempSign = Math.random()<0.5 ? "-" : "+";
    rollEl.textContent = tempSign + tempNum;
    rollEl.className = "roll " + (tempSign==="+"?"plus":"minus");
    ticks++;
    if(ticks>=totalTicks){ clearInterval(interval); finalizeRoll(); }
  },50);
}

async function finalizeRoll(){
  const rollNumber = Math.floor(Math.random()*200)+1;
  const positive = Math.random()<0.5;
  const change = positive ? rollNumber : -rollNumber;

  score = Math.max(0, score + change);

  const rollEl = document.getElementById("roll");
  rollEl.textContent = (change>=0?"+":"") + rollNumber;
  rollEl.className = "roll " + (change>=0?"plus":"minus");

  document.getElementById("score").textContent = score;

  // Save score in Firestore
  await db.collection("users").doc(currentUser).update({ score });

  rolling = false;
  updateLeaderboard();
}

// --- Leaderboard ---
async function updateLeaderboard(){
  const lbEl = document.getElementById("leaderboard");
  try{
    const snapshot = await db.collection("users").orderBy("score","desc").limit(12).get();
    lbEl.innerHTML = "";
    let count = 0;
    snapshot.forEach(doc=>{
      count++;
      const div = document.createElement("div");
      div.textContent = count + ". " + doc.id + " (" + doc.data().score + ")";
      lbEl.appendChild(div);
    });
  }catch(e){
    lbEl.textContent = "Error loading leaderboard";
  }
}
</script>
</body>
</html>